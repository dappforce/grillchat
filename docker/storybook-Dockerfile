FROM node:20-slim as builder

ARG GH_SERVER_MNEMONIC
ARG GH_SERVER_DISCUSSION_CREATOR_MNEMONIC
ARG GH_USER_ID_SALT
ARG GH_CRUST_IPFS_AUTH
ARG GH_NEXT_PUBLIC_APP_ID
ARG GH_NEXT_PUBLIC_SPACE_IDS
ARG GH_MODERATION_URL
ARG GH_MODERATION_TOKEN
ARG GH_NEXT_PUBLIC_NOTIFICATION_APP_ID
ARG GH_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
ARG GH_NEXT_PUBLIC_FIREBASE_PROJECT_ID
ARG GH_NEXT_PUBLIC_FIREBASE_API_KEY
ARG GH_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
ARG GH_NEXT_PUBLIC_FIREBASE_MESSAGING_ID
ARG GH_NEXT_PUBLIC_FIREBASE_APP_ID
ARG GH_NOTIFICATIONS_URL
ARG GH_NOTIFICATIONS_TOKEN
ARG GH_NEXT_PUBLIC_AMP_ID
ARG GH_NEXT_PUBLIC_SQUID_URL
ARG GH_NEXT_PUBLIC_COMMUNITY_HUB_ID
ARG GH_NEXT_PUBLIC_GA_ID
ARG GH_IPFS_WRITE_URL
ARG GH_IPFS_PIN_URL
ARG GH_COVALENT_API_KEY
ARG GH_SUBSOCIAL_PROMO_SECRET_HEX
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_DATAHUB_QUEUE_TOKEN
ARG GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS
ARG GH_TWITTER_CLIENT_ID
ARG GH_TWITTER_CLIENT_SECRET
ARG GH_NEXTAUTH_SECRET
ARG GH_NEXTAUTH_URL

ENV NEXT_PUBLIC_APP_ID=${GH_NEXT_PUBLIC_APP_ID} \
    NEXT_PUBLIC_SPACE_IDS=${GH_NEXT_PUBLIC_SPACE_IDS} \
    MODERATION_URL=${GH_MODERATION_URL} \
    MODERATION_TOKEN=${GH_MODERATION_TOKEN} \
    NEXT_PUBLIC_NOTIFICATION_APP_ID=${GH_NEXT_PUBLIC_NOTIFICATION_APP_ID} \
    NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${GH_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN} \
    NEXT_PUBLIC_FIREBASE_PROJECT_ID=${GH_NEXT_PUBLIC_FIREBASE_PROJECT_ID} \
    NEXT_PUBLIC_FIREBASE_API_KEY=${GH_NEXT_PUBLIC_FIREBASE_API_KEY} \
    NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${GH_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET} \
    NEXT_PUBLIC_FIREBASE_MESSAGING_ID=${GH_NEXT_PUBLIC_FIREBASE_MESSAGING_ID} \
    NEXT_PUBLIC_FIREBASE_APP_ID=${GH_NEXT_PUBLIC_FIREBASE_APP_ID} \
    NOTIFICATIONS_URL=${GH_NOTIFICATIONS_URL} \
    NOTIFICATIONS_TOKEN=${GH_NOTIFICATIONS_TOKEN} \
    NEXT_PUBLIC_AMP_ID=${GH_NEXT_PUBLIC_AMP_ID} \
    NEXT_PUBLIC_SQUID_URL=${GH_NEXT_PUBLIC_SQUID_URL} \
    NEXT_PUBLIC_COMMUNITY_HUB_ID=${GH_NEXT_PUBLIC_COMMUNITY_HUB_ID} \
    NEXT_PUBLIC_GA_ID=${GH_NEXT_PUBLIC_GA_ID} \
    IPFS_WRITE_URL=${GH_IPFS_WRITE_URL} \
    IPFS_PIN_URL=${GH_IPFS_PIN_URL} \
    USER_ID_SALT=${GH_USER_ID_SALT} \
    CRUST_IPFS_AUTH=${GH_CRUST_IPFS_AUTH} \
    SERVER_MNEMONIC=${GH_SERVER_MNEMONIC} \
    SERVER_DISCUSSION_CREATOR_MNEMONIC=${GH_SERVER_DISCUSSION_CREATOR_MNEMONIC} \
    COVALENT_API_KEY=${GH_COVALENT_API_KEY} \
    SUBSOCIAL_PROMO_SECRET_HEX=${GH_SUBSOCIAL_PROMO_SECRET_HEX} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    DATAHUB_QUEUE_TOKEN=${GH_DATAHUB_QUEUE_TOKEN} \
    NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS=${GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS} \
    TWITTER_CLIENT_ID=${GH_TWITTER_CLIENT_ID} \
    TWITTER_CLIENT_SECRET=${GH_TWITTER_CLIENT_SECRET} \
    NEXTAUTH_SECRET=${GH_NEXTAUTH_SECRET} \
    NEXTAUTH_URL=${GH_NEXTAUTH_URL}

WORKDIR /opt/subsocial/app

COPY package.json yarn.lock* ./

RUN yarn install

COPY . .

RUN set -x \
    && mv ci.env .env \
    && yarn build

FROM gcr.io/distroless/nodejs:18 AS runner

ARG GH_SERVER_MNEMONIC
ARG GH_SERVER_DISCUSSION_CREATOR_MNEMONIC
ARG GH_USER_ID_SALT
ARG GH_CRUST_IPFS_AUTH
ARG GH_NEXT_PUBLIC_APP_ID
ARG GH_NEXT_PUBLIC_SPACE_IDS
ARG GH_MODERATION_URL
ARG GH_MODERATION_TOKEN
ARG GH_NEXT_PUBLIC_NOTIFICATION_APP_ID
ARG GH_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
ARG GH_NEXT_PUBLIC_FIREBASE_PROJECT_ID
ARG GH_NEXT_PUBLIC_FIREBASE_API_KEY
ARG GH_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
ARG GH_NEXT_PUBLIC_FIREBASE_MESSAGING_ID
ARG GH_NEXT_PUBLIC_FIREBASE_APP_ID
ARG GH_NOTIFICATIONS_URL
ARG GH_NOTIFICATIONS_TOKEN
ARG GH_NEXT_PUBLIC_AMP_ID
ARG GH_NEXT_PUBLIC_SQUID_URL
ARG GH_NEXT_PUBLIC_COMMUNITY_HUB_ID
ARG GH_NEXT_PUBLIC_GA_ID
ARG GH_IPFS_WRITE_URL
ARG GH_IPFS_PIN_URL
ARG GH_COVALENT_API_KEY
ARG GH_SUBSOCIAL_PROMO_SECRET_HEX
ARG GH_NEXT_PUBLIC_DATAHUB_QUERY_URL
ARG GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL
ARG GH_DATAHUB_QUEUE_URL
ARG GH_DATAHUB_QUEUE_TOKEN
ARG GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS
ARG GH_TWITTER_CLIENT_ID
ARG GH_TWITTER_CLIENT_SECRET
ARG GH_NEXTAUTH_SECRET
ARG GH_NEXTAUTH_URL

ENV NEXT_PUBLIC_APP_ID=${GH_NEXT_PUBLIC_APP_ID} \
    NEXT_PUBLIC_SPACE_IDS=${GH_NEXT_PUBLIC_SPACE_IDS} \
    MODERATION_URL=${GH_MODERATION_URL} \
    MODERATION_TOKEN=${GH_MODERATION_TOKEN} \
    NEXT_PUBLIC_NOTIFICATION_APP_ID=${GH_NEXT_PUBLIC_NOTIFICATION_APP_ID} \
    NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${GH_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN} \
    NEXT_PUBLIC_FIREBASE_PROJECT_ID=${GH_NEXT_PUBLIC_FIREBASE_PROJECT_ID} \
    NEXT_PUBLIC_FIREBASE_API_KEY=${GH_NEXT_PUBLIC_FIREBASE_API_KEY} \
    NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${GH_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET} \
    NEXT_PUBLIC_FIREBASE_MESSAGING_ID=${GH_NEXT_PUBLIC_FIREBASE_MESSAGING_ID} \
    NEXT_PUBLIC_FIREBASE_APP_ID=${GH_NEXT_PUBLIC_FIREBASE_APP_ID} \
    NOTIFICATIONS_URL=${GH_NOTIFICATIONS_URL} \
    NOTIFICATIONS_TOKEN=${GH_NOTIFICATIONS_TOKEN} \
    NEXT_PUBLIC_AMP_ID=${GH_NEXT_PUBLIC_AMP_ID} \
    NEXT_PUBLIC_SQUID_URL=${GH_NEXT_PUBLIC_SQUID_URL} \
    NEXT_PUBLIC_COMMUNITY_HUB_ID=${GH_NEXT_PUBLIC_COMMUNITY_HUB_ID} \
    NEXT_PUBLIC_GA_ID=${GH_NEXT_PUBLIC_GA_ID} \
    IPFS_WRITE_URL=${GH_IPFS_WRITE_URL} \
    IPFS_PIN_URL=${GH_IPFS_PIN_URL} \
    USER_ID_SALT=${GH_USER_ID_SALT} \
    CRUST_IPFS_AUTH=${GH_CRUST_IPFS_AUTH} \
    SERVER_MNEMONIC=${GH_SERVER_MNEMONIC} \
    SERVER_DISCUSSION_CREATOR_MNEMONIC=${GH_SERVER_DISCUSSION_CREATOR_MNEMONIC} \
    COVALENT_API_KEY=${GH_COVALENT_API_KEY} \
    SUBSOCIAL_PROMO_SECRET_HEX=${GH_SUBSOCIAL_PROMO_SECRET_HEX} \
    NEXT_PUBLIC_DATAHUB_QUERY_URL=${GH_NEXT_PUBLIC_DATAHUB_QUERY_URL} \
    NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL=${GH_NEXT_PUBLIC_DATAHUB_SUBSCRIPTION_URL} \
    DATAHUB_QUEUE_URL=${GH_DATAHUB_QUEUE_URL} \
    DATAHUB_QUEUE_TOKEN=${GH_DATAHUB_QUEUE_TOKEN} \
    NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS=${GH_NEXT_PUBLIC_OFFCHAIN_POSTING_HUBS} \
    TWITTER_CLIENT_ID=${GH_TWITTER_CLIENT_ID} \
    TWITTER_CLIENT_SECRET=${GH_TWITTER_CLIENT_SECRET} \
    NEXTAUTH_SECRET=${GH_NEXTAUTH_SECRET} \
    NEXTAUTH_URL=${GH_NEXTAUTH_URL}

WORKDIR /opt/subsocial/app

COPY --from=builder /opt/subsocial/app .

CMD [ "/opt/subsocial/app/node_modules/.bin/next", "start" ]


FROM builder as storybook

RUN yarn build-storybook

CMD [ "yarn", "start-storybook"]