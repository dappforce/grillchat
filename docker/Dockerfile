FROM node:18-slim as builder

ARG GH_SERVER_MNEMONIC
ARG GH_CAPTCHA_SECRET
ARG GH_USER_ID_SALT
ARG GH_CRUST_IPFS_AUTH
ARG GH_NEXT_PUBLIC_CAPTCHA_SITE_KEY
ARG GH_NEXT_PUBLIC_SPACE_IDS
ARG GH_NEXT_PUBLIC_MODERATION_URL
ARG GH_NEXT_PUBLIC_AMP_ID
ARG GH_NEXT_PUBLIC_GA_ID
ARG GH_IPFS_PIN_URL

ENV NEXT_PUBLIC_CAPTCHA_SITE_KEY=${GH_NEXT_PUBLIC_CAPTCHA_SITE_KEY} \
    NEXT_PUBLIC_SPACE_IDS=${GH_NEXT_PUBLIC_SPACE_IDS} \
    NEXT_PUBLIC_MODERATION_URL=${GH_NEXT_PUBLIC_MODERATION_URL} \
    NEXT_PUBLIC_AMP_ID=${GH_NEXT_PUBLIC_AMP_ID} \
    NEXT_PUBLIC_GA_ID=${GH_NEXT_PUBLIC_GA_ID} \
    IPFS_PIN_URL=${GH_IPFS_PIN_URL} \
    CAPTCHA_SECRET=${GH_CAPTCHA_SECRET} \
    USER_ID_SALT=${GH_USER_ID_SALT} \
    CRUST_IPFS_AUTH=${GH_CRUST_IPFS_AUTH} \
    SERVER_MNEMONIC=${GH_SERVER_MNEMONIC}

COPY . /opt/subsocial/app

WORKDIR /opt/subsocial/app

RUN set -x \
    && mv ci.env .env \
    && yarn install && \
    yarn build

ENTRYPOINT [ "yarn", "start" ]
